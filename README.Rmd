---
title: "Gray-headed Chickadee Simulation Analysis"
author: "David Iles"
date: "Generated on `r Sys.Date()`"
output: 
  md_document:
    variant: markdown_github
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "png",
  dev.args = list(type = "cairo-png"),
  fig.width = 8,
  fig.height = 8,
  eval = TRUE,
  echo = TRUE,
  warning = FALSE,
  error = FALSE,
  message = FALSE
)
```

# Motivation

The goal of this study is to evaluate the sample size requirements to estimate population sizes of Gray-headed Chickadee in Alaska.

# Simulation description

```{r, include=FALSE, echo = FALSE}
library(sp)
library(sf)
library(tidyverse)
library(jagsUI)

rm(list=ls())
options(scipen=10000)
load("power_wksp.RData")
```

These simulations place home ranges on a hypothetical landscape, and conduct simple random sampling across that landscape to estimate the expected number of detections that would occur under various population/sampling scenarios.

The simulated data are then analyzed with a Bayesian model to produce estimates of population size, which can then be compared to the 'true' (i.e., simulated) numbers of birds.  These estimates of population size are then used to conduct precision and power analyses.

### Simulation assumptions

1) bird territories are distributed randomly across available habitat
2) bird territory boundaries do not overlap
3) the area of potentially suitable GHCH habitat in AK is `r plot_area` km<sup>2</sup> (estimated based on remote sensing)
4) surveys are positioned independently of bird occurrence
5) surveys are not clustered

### Example of simulated landscape and survey

We assume in this example that there are 1000 GHCH pairs distributed across the landscape, such that density is `r round(1000/plot_area,3)` birds/km<sup>2</sup>.  Later, we will conduct a full suite of simulations across multiple hypothetical GHCH population sizes.

The plot below illustrates the spatial distribution of GHCH territories for one realization of the simulation.

```{r chunk1, echo = FALSE,fig.width=10, fig.height=10}

  n_males = 1000
  n_ARU = 300
  
  # --------------------------------------------------
  # Simulate bird territories
  # --------------------------------------------------
  
  # Bird territories
  bird_centroids <- sample_n(birdgrid,n_males)
  
  # Detectable radius of each location
  bird_TD = st_buffer(bird_centroids, bird_TrD)
  
  # Plot bird territories
  bird_radius_m = round(bird_Tr*1000)
  
  bird_plot <- ggplot() +
    geom_sf(data = bird_TD,fill = "transparent", col = "blue")+
    scale_fill_manual(values = c("transparent","orangered"),na.value = "transparent",name="Detection")+
    coord_sf(xlim = c(-dim,dim), ylim = c(-dim,dim))+
    xlab("km")+ylab("km")+
    ggtitle(paste0("Number of males = ",n_males,"\nBird Territory Radius = ",bird_radius_m," m\nBird EDR = ",bird_EDR*1000," m"))
  
  print(bird_plot)

```

Next, we position a number of ARUs on the landscape.

```{r chunk2, echo = FALSE,fig.width=10, fig.height=10}

  # --------------------------------------------------
  # Simulate ARU placement
  # --------------------------------------------------
  
  # SRS sampling
  aru_sf <- sample_n(ARUgrid,n_ARU)
  
  aru_detections <- sf::st_intersects(bird_TD,aru_sf) %>% as.data.frame()
  
  bird_TD$det = "no"
  
  if (nrow(aru_detections) > 0){
    bird_TD$det[aru_detections[,1]] <- "yes"
  }
  
  # Plot ARU locations
  aru_plot <- ggplot() +
    geom_sf(data = bird_TD,aes(fill = det), col = "blue", linetype = 2)+
    geom_sf(data = aru_sf, shape = 19)+
    scale_fill_manual(values = c("transparent","red"),na.value = "transparent",name="Detection")+
    coord_sf(xlim = c(-dim,dim), ylim = c(-dim,dim))+
    xlab("km")+ylab("km")+
    ggtitle(paste0("Number of males = ",n_males,"\nBird Territory Radius = ",bird_radius_m," m\nBird EDR = ",bird_EDR*1000," m"))

  print(aru_plot)
  
   # --------------------------------------------------
  # Calculate number of ARUs with detections
  # --------------------------------------------------
  n_ARU_det <- length(unique(aru_detections$col.id))
  n_ARU_det
  
```

In this example we positioned 300 ARUs, and obtained `r n_ARU_det` detections of GHCH.

# Simulation results


```{r chunk3, echo=FALSE}

```
